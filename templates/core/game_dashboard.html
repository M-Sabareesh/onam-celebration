{% extends 'base.html' %}

{% block title %}{{ player.name }} Dashboard - à´“à´£à´¾à´˜àµ‹à´·à´‚{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Player Info Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="game-card text-center position-relative">
                <!-- Mahabali blessing icon -->
                <div class="position-absolute top-0 end-0 p-3">
                    <div class="mahabali-image-container" style="width: 50px; height: 50px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Mahabali.jpg/50px-Mahabali.jpg" 
                             alt="King Mahabali blessing" 
                             class="rounded-circle mahabali-img"
                             style="width: 50px; height: 50px; object-fit: cover; border: 2px solid var(--onam-gold);"
                             title="King Mahabali's Blessings"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <!-- Fallback with crown emoji -->
                        <div class="mahabali-fallback d-none align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--onam-gold), var(--kerala-yellow)); border-radius: 50%; border: 2px solid var(--onam-gold);"
                             title="King Mahabali's Blessings">
                            <div style="font-size: 1.5rem;">ðŸ‘‘</div>
                        </div>
                    </div>
                </div>
                
                <h2 class="mb-3">
                    <i class="fas fa-crown text-warning me-2"></i>
                    Welcome, {{ player.name }}!
                    <span class="badge bg-success ms-2">ðŸŸ¢ Online</span>
                </h2>
                <p class="text-muted mb-3">
                    <i class="fas fa-star text-warning me-1"></i>
                    May King Mahabali bless your Onam journey
                </p>
                <div class="mb-3">
                    {% if player.team != 'unassigned' %}
                        <span class="badge bg-primary fs-6 me-2">{{ player_team }}</span>
                        <span class="text-muted">Your Team</span>
                    {% else %}
                        <span class="badge bg-warning text-dark fs-6 me-2">Awaiting Team Assignment</span>
                        <span class="text-muted">Admin will assign you to a team</span>
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="display-6 text-success">{{ questions_completed }}</div>
                            <small>Questions Answered</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="display-6 text-warning">{{ player.score }}</div>
                            <small>Total Score</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="display-6 text-info">{{ total_questions }}</div>
                            <small>Total Questions</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="badge bg-success">{{ total_online_players }} Online</div>
                            <small>Total Players</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Team Information and Game Start -->
    <div class="row mb-4">
        {% if player.team != 'unassigned' %}
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        {{ player_team }} Members
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-success mb-2">Your Teammates:</h6>
                        {% if teammates %}
                            {% for teammate in teammates %}
                            <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded" data-player-id="{{ teammate.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user text-muted me-2"></i>
                                    <span>{{ teammate.name }}</span>
                                </div>
                                <div class="online-status">
                                    {% if teammate.is_online %}
                                        <span class="badge bg-success">ðŸŸ¢ Online</span>
                                    {% else %}
                                        <span class="badge bg-secondary">âš« Offline</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="badge bg-info">{{ teammate.score }} pts</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">You're the only member in this team so far!</p>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="text-info mb-2">Team Leaderboard:</h6>
                        {% for team_member in team_leaderboard %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span {% if team_member.id == player.id %}class="fw-bold text-primary"{% endif %}>
                                {{ forloop.counter }}. {{ team_member.name }}
                                {% if team_member.id == player.id %} (You){% endif %}
                            </span>
                            <span class="badge bg-warning text-dark">{{ team_member.score }} pts</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="col-md-{% if player.team != 'unassigned' %}6{% else %}12{% endif %}">
            <div class="card h-100 text-center p-4">
                <h4 class="text-success mb-3">
                    <i class="fas fa-crown me-2"></i>
                    Onam Aghosham Treasure Hunt
                </h4>
                <p>Ready for Onam celebration in honor of King Maveli? Answer questions and upload photos!</p>
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {% if total_questions > 0 %}{% widthratio questions_completed total_questions 100 %}{% else %}0{% endif %}%"
                         aria-valuenow="{{ questions_completed }}" 
                         aria-valuemin="0" 
                         aria-valuemax="{{ total_questions }}">
                    </div>
                </div>
                <small class="text-muted mb-3 d-block">{{ questions_completed }} of {{ total_questions }} completed</small>
                <a href="{% url 'core:treasure_hunt' %}" class="btn btn-onam btn-lg">
                    <i class="fas fa-play me-2"></i>Let's Start Onam!
                </a>
                
                {% if player.team == 'unassigned' %}
                <div class="mt-3 p-3 bg-warning bg-opacity-25 rounded">
                    <p class="mb-0 text-dark">
                        <i class="fas fa-info-circle me-2"></i>
                        You can start playing while waiting for team assignment!
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
                    Onam Knowledge
                </h4>
                <p>Learn about the beautiful traditions of Kerala's most beloved festival.</p>
                <div class="mb-3">
                    <span class="badge bg-success me-2">Pookalam</span>
                    <span class="badge bg-warning me-2">Sadhya</span>
                    <span class="badge bg-danger me-2">Pulikali</span>
                </div>
                <a href="{% url 'core:about' %}" class="btn btn-outline-success btn-lg">
                    <i class="fas fa-book me-2"></i>Learn More
                </a>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="text-success mb-3">
                <i class="fas fa-trophy me-2"></i>Leaderboard
            </h3>
            <div class="row">
                {% for leader in leaderboard %}
                <div class="col-md-6 mb-2">
                    <div class="leaderboard-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="rank-badge rank-{{ forloop.counter }}">{{ forloop.counter }}</span>
                            <span class="ms-3 fw-bold{% if leader.id == player.id %} text-success{% endif %}">
                                {{ leader.name }}
                                {% if leader.id == player.id %}<i class="fas fa-star ms-1"></i>{% endif %}
                            </span>
                        </div>
                        <div>
                            <span class="badge bg-onam-gold text-dark">{{ leader.score }} pts</span>
                            <small class="text-muted ms-2">Level {{ leader.current_level }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    {% if recent_sessions %}
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="text-success mb-3">
                <i class="fas fa-history me-2"></i>Recent Activity
            </h4>
            <div class="row">
                {% for session in recent_sessions %}
                <div class="col-md-4 mb-2">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Level {{ session.level }}</h6>
                            <small class="text-muted">{{ session.started_at|date:"M d, H:i" }}</small>
                            {% if session.completed %}
                                <div class="text-success mt-2">
                                    <i class="fas fa-check-circle"></i> Completed
                                </div>
                            {% else %}
                                <div class="text-warning mt-2">
                                    <i class="fas fa-clock"></i> In Progress
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Navigation -->
    <div class="row">
        <div class="col-12 text-center">
            <a href="{% url 'core:leaderboard' %}" class="btn btn-outline-success me-2">
                <i class="fas fa-chart-line me-2"></i>View Full Leaderboard
            </a>
            <a href="{% url 'core:logout' %}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
        </div>
    </div>
</div>

<style>
.stat-item {
    padding: 1rem;
}

.rank-1 { background: #FFD700; color: #333; }
.rank-2 { background: #C0C0C0; color: #333; }
.rank-3 { background: #CD7F32; color: white; }
.rank-other { background: var(--onam-green); color: white; }
</style>

<script>
function startGame() {
    alert('ðŸŒ¸ Game starting soon! This feature will include SMS-based clues and Onam trivia. Stay tuned for the full treasure hunt experience! à´“à´£à´¾à´¶à´‚à´¸à´•àµ¾!');
}

    // Auto-refresh team status every 30 seconds
    function refreshTeamStatus() {
        fetch('{% url "core:team_status_api" %}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.log('Error fetching team status:', data.error);
                    return;
                }
                
                // Update online status indicators
                data.teammates.forEach(teammate => {
                    const statusElement = document.querySelector(`[data-player-id="${teammate.id}"] .online-status`);
                    if (statusElement) {
                        if (teammate.is_online) {
                            statusElement.innerHTML = '<span class="badge bg-success">ðŸŸ¢ Online</span>';
                        } else {
                            statusElement.innerHTML = '<span class="badge bg-secondary">âš« Offline</span>';
                        }
                    }
                });
                
                // Update global stats
                const totalOnlineElement = document.querySelector('#total-online-count');
                if (totalOnlineElement) {
                    totalOnlineElement.textContent = data.global_stats.total_online;
                }
            })
            .catch(error => {
                console.log('Error fetching team status:', error);
            });
    }
    
    // Refresh every 30 seconds
    setInterval(refreshTeamStatus, 30000);
    
    // Initial refresh after 5 seconds
    setTimeout(refreshTeamStatus, 5000);
    </script>
    <!-- Progress bar animation -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.transition = 'width 1s ease-in-out';
        }
    });
    </script>
{% endblock %}
